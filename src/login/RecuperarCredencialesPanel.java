/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package login;

import courseroom.MainFrame;
import java.awt.GradientPaint;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.event.KeyEvent;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.regex.Pattern;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Multipart;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;
import javax.swing.JOptionPane;
import javax.swing.SwingUtilities;

/**
 *
 * @author LENOVO
 */
public class RecuperarCredencialesPanel extends javax.swing.JPanel{

    private Pattern pattern;
    private Properties properties;
    private Session session;
    private InputStream inputStream;
    private BufferedReader bufferedReader;
    private StringBuilder msjHTML;
    private MimeBodyPart mimeBodyPartHTML;
    private MimeMessage mimeMessage;
    private InternetAddress internetAddress;
    private Multipart multipart;
    
    /**
     * Creates new form RecuperarCredencialesPanel
     */
    @SuppressWarnings("OverridableMethodCallInConstructor")
    public RecuperarCredencialesPanel() {
        initComponents();
        jLabelLogo.setIcon(MainFrame.getLogoImage());
        

        pattern = Pattern.compile("[ -~]+@[ -~]+", Pattern.CASE_INSENSITIVE);

        try {
            //Crear las propiedades para mandar el correo
            properties = new Properties();
            properties.put("mail.smtp.host", "smtp.outlook.com");
            properties.put("mail.smtp.starttls.enable", "true");
            properties.put("mail.smtp.port", "587");
            properties.put("mail.smtp.auth", "true");

            // Obtener la sesion
            session = Session.getInstance(properties, null);

            // Leer la plantilla
            inputStream = getClass().getResourceAsStream("../resources/html/mensaje.html");
            bufferedReader = new BufferedReader(new InputStreamReader(inputStream));

            // Almacenar el contenido de la plantilla en un StringBuffer
            String strLine;
            msjHTML = new StringBuilder();

            while ((strLine = bufferedReader.readLine()) != null) {
                msjHTML.append(strLine);
            }

            strLine = null;
            // Crear la parte del mensaje HTML
            mimeBodyPartHTML = new MimeBodyPart();
            mimeBodyPartHTML.setContent(msjHTML.toString(), "text/html");

            // Crear el cuerpo del mensaje
            mimeMessage = new MimeMessage(session);

            // Agregar el asunto al correo
            mimeMessage.setSubject("Course Room -  Mensaje De Recuperación.");

            // Agregar quien envía el correo
            mimeMessage.setFrom(new InternetAddress("Course_Room@outlook.com", "Course Room Mensaje De Recuperación"));

            // Crear el multipart para agregar la parte del mensaje anterior
            multipart = new MimeMultipart();

            // Agregar la parte del mensaje  de recuperación HTML al multiPart
            multipart.addBodyPart(mimeBodyPartHTML);

            internetAddress = new InternetAddress();

        } catch (IOException | MessagingException ex) {
            System.out.println("main.RecuperarCredencialesController.initialize(): " + ex.getMessage());
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabelLogo = new javax.swing.JLabel();
        jLabelTitulo = new javax.swing.JLabel();
        jLabelFrase = new javax.swing.JLabel();
        jLabelCorreoElectronico = new javax.swing.JLabel();
        jTextFieldCorreoElectronico = new javax.swing.JTextField();
        jButtonRecuperarCredenciales = new javax.swing.JButton();
        jLabelRegresar = new javax.swing.JLabel();

        setMinimumSize(new java.awt.Dimension(800, 600));

        jLabelLogo.setBackground(new java.awt.Color(14, 30, 64));
        jLabelLogo.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabelLogo.setToolTipText("CourseRoom Logo");
        jLabelLogo.setMaximumSize(new java.awt.Dimension(567, 125));
        jLabelLogo.setMinimumSize(new java.awt.Dimension(567, 125));
        jLabelLogo.setPreferredSize(new java.awt.Dimension(567, 125));

        jLabelTitulo.setBackground(new java.awt.Color(14, 30, 64));
        jLabelTitulo.setFont(new java.awt.Font("Gadugi", 1, 28)); // NOI18N
        jLabelTitulo.setForeground(new java.awt.Color(104, 194, 232));
        jLabelTitulo.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabelTitulo.setText("¿Has Olvidado Tu Usuario &/O Contraseña?");
        jLabelTitulo.setPreferredSize(new java.awt.Dimension(500, 38));

        jLabelFrase.setBackground(new java.awt.Color(14, 30, 64));
        jLabelFrase.setFont(new java.awt.Font("Gadugi", 0, 21)); // NOI18N
        jLabelFrase.setForeground(new java.awt.Color(104, 194, 232));
        jLabelFrase.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabelFrase.setText("<html><p style=\"text-align:center;\">No te preocupes. Solamente te pediremos que ingreses<br>el correo electrónico que registraste en tu cuenta.<br>Te mandaremos tu nombre de usuario y contraseña.</p></html>");
        jLabelFrase.setPreferredSize(new java.awt.Dimension(500, 116));

        jLabelCorreoElectronico.setFont(new java.awt.Font("Gadugi", 1, 21)); // NOI18N
        jLabelCorreoElectronico.setForeground(new java.awt.Color(14, 30, 64));
        jLabelCorreoElectronico.setText("Correo Electrónico");
        jLabelCorreoElectronico.setMaximumSize(new java.awt.Dimension(500, 30));
        jLabelCorreoElectronico.setMinimumSize(new java.awt.Dimension(500, 30));
        jLabelCorreoElectronico.setPreferredSize(new java.awt.Dimension(500, 30));

        jTextFieldCorreoElectronico.setBackground(new java.awt.Color(14, 30, 64));
        jTextFieldCorreoElectronico.setFont(new java.awt.Font("Gadugi", 0, 24)); // NOI18N
        jTextFieldCorreoElectronico.setForeground(new java.awt.Color(104, 194, 232));
        jTextFieldCorreoElectronico.setToolTipText("Ingresa Aquí Tu Correo Electrónico De Tu Cuenta Para Enviarte Tus Credenciales");
        jTextFieldCorreoElectronico.setCaretColor(new java.awt.Color(104, 194, 232));
        jTextFieldCorreoElectronico.setPreferredSize(new java.awt.Dimension(500, 43));
        jTextFieldCorreoElectronico.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jTextFieldCorreoElectronicoKeyPressed(evt);
            }
        });

        jButtonRecuperarCredenciales.setBackground(new java.awt.Color(14, 30, 64));
        jButtonRecuperarCredenciales.setFont(new java.awt.Font("Gadugi", 1, 36)); // NOI18N
        jButtonRecuperarCredenciales.setForeground(new java.awt.Color(104, 194, 232));
        jButtonRecuperarCredenciales.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/icons/data.png"))); // NOI18N
        jButtonRecuperarCredenciales.setText(" Recuperar Credenciales ");
        jButtonRecuperarCredenciales.setToolTipText("Click Para Enviar Correo De Recuperación De Credenciales");
        jButtonRecuperarCredenciales.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        jButtonRecuperarCredenciales.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jButtonRecuperarCredenciales.setPreferredSize(new java.awt.Dimension(500, 54));
        jButtonRecuperarCredenciales.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jButtonRecuperarCredencialesMouseClicked(evt);
            }
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                jButtonRecuperarCredencialesMouseEntered(evt);
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                jButtonRecuperarCredencialesMouseExited(evt);
            }
        });

        jLabelRegresar.setFont(new java.awt.Font("Segoe UI", 1, 50)); // NOI18N
        jLabelRegresar.setForeground(new java.awt.Color(14, 30, 64));
        jLabelRegresar.setHorizontalAlignment(javax.swing.SwingConstants.TRAILING);
        jLabelRegresar.setText("←");
        jLabelRegresar.setToolTipText("Regresa A La Página De Login");
        jLabelRegresar.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jLabelRegresar.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jLabelRegresar.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jLabelRegresarMouseClicked(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabelRegresar)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(110, 110, 110)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabelLogo, javax.swing.GroupLayout.DEFAULT_SIZE, 579, Short.MAX_VALUE)
                            .addComponent(jLabelTitulo, javax.swing.GroupLayout.DEFAULT_SIZE, 579, Short.MAX_VALUE)
                            .addComponent(jLabelFrase, javax.swing.GroupLayout.DEFAULT_SIZE, 579, Short.MAX_VALUE)
                            .addComponent(jTextFieldCorreoElectronico, javax.swing.GroupLayout.DEFAULT_SIZE, 579, Short.MAX_VALUE)
                            .addComponent(jButtonRecuperarCredenciales, javax.swing.GroupLayout.DEFAULT_SIZE, 579, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabelCorreoElectronico, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                                .addGap(388, 388, 388)))))
                .addGap(105, 105, 105))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(20, 20, 20)
                .addComponent(jLabelLogo, javax.swing.GroupLayout.DEFAULT_SIZE, 149, Short.MAX_VALUE)
                .addGap(5, 5, 5)
                .addComponent(jLabelTitulo, javax.swing.GroupLayout.DEFAULT_SIZE, 62, Short.MAX_VALUE)
                .addGap(7, 7, 7)
                .addComponent(jLabelFrase, javax.swing.GroupLayout.DEFAULT_SIZE, 111, Short.MAX_VALUE)
                .addGap(25, 25, 25)
                .addComponent(jLabelCorreoElectronico, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGap(5, 5, 5)
                .addComponent(jTextFieldCorreoElectronico, javax.swing.GroupLayout.DEFAULT_SIZE, 45, Short.MAX_VALUE)
                .addGap(25, 25, 25)
                .addComponent(jButtonRecuperarCredenciales, javax.swing.GroupLayout.DEFAULT_SIZE, 55, Short.MAX_VALUE)
                .addGap(18, 18, 18)
                .addComponent(jLabelRegresar, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

        @Override
    protected void paintComponent(Graphics g) {
        
        super.paintComponent(g);
        Graphics2D g2d = (Graphics2D) g;
        int w = getWidth();
        int h = getHeight();
        GradientPaint gp = new GradientPaint(0, 0, MainFrame.getDarkBlue(), 0, h, MainFrame.getLightBlue());
        g2d.setPaint(gp);
        g2d.fillRect(0, 0, w, h);
        g2d = null;
        gp = null;
        
    }
    
    private void jTextFieldCorreoElectronicoKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jTextFieldCorreoElectronicoKeyPressed
        // TODO add your handling code here:
        if(evt.getKeyCode() == KeyEvent.VK_ENTER)
            enviarInformacion();
    }//GEN-LAST:event_jTextFieldCorreoElectronicoKeyPressed

    private void jButtonRecuperarCredencialesMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jButtonRecuperarCredencialesMouseClicked
        // TODO add your handling code here:
        if(SwingUtilities.isLeftMouseButton(evt))
            enviarInformacion();

    }//GEN-LAST:event_jButtonRecuperarCredencialesMouseClicked

    private void jLabelRegresarMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jLabelRegresarMouseClicked
        // TODO add your handling code here:
        if(SwingUtilities.isLeftMouseButton(evt)){
            this.setVisible(false);
            MainFrame.showLogin();
        }
        
    }//GEN-LAST:event_jLabelRegresarMouseClicked

    private void jButtonRecuperarCredencialesMouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jButtonRecuperarCredencialesMouseEntered
        // TODO add your handling code here:
        jButtonRecuperarCredenciales.setBackground(MainFrame.getLightBlue());
        jButtonRecuperarCredenciales.setForeground(MainFrame.getDarkBlue());
    }//GEN-LAST:event_jButtonRecuperarCredencialesMouseEntered

    private void jButtonRecuperarCredencialesMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jButtonRecuperarCredencialesMouseExited
        // TODO add your handling code here:
        jButtonRecuperarCredenciales.setBackground(MainFrame.getDarkBlue());
        jButtonRecuperarCredenciales.setForeground(MainFrame.getLightBlue());
    }//GEN-LAST:event_jButtonRecuperarCredencialesMouseExited

    private boolean esCorreoElectronico(String value){
        return pattern.matcher(value).find();
    }
    
    public boolean enviarCorreoRecuperacion() {
        //Buscar el nombre de usuario y la contraseña en la base de datos:
        String nombreDeUsuario = "El Admin";
        String contrasena = "123456789";

       try {

            // Destinatario
            internetAddress.setAddress(jTextFieldCorreoElectronico.getText());
            
            // Agregar destinatario al mensaje
            mimeMessage.setRecipient(Message.RecipientType.TO,internetAddress);

            // Creo la parte del mensaje HTML
            MimeBodyPart mimeBodyPartMensaje = new MimeBodyPart();
            mimeBodyPartMensaje.setFileName("Informacion De La Cuenta.txt");
            mimeBodyPartMensaje.setText("Nombre De Usuario: "+nombreDeUsuario+"\nContraseña: "+contrasena);

            // Agregar la parte del mensaje HTML al multiPart
            multipart.addBodyPart(mimeBodyPartMensaje);

            // Agregar el multipart al cuerpo del mensaje
            mimeMessage.setContent(multipart);

           try ( // Enviar el mensaje
                Transport transport = session.getTransport("smtp")) {
                transport.connect("Course_Room@outlook.com","cuceiUDG");
                transport.sendMessage(mimeMessage, mimeMessage.getAllRecipients());
                transport.close();
           }
           
           mimeBodyPartMensaje = null;

       } catch (MessagingException ex) {
           System.out.println("main.RecuperarCredencialesController.mandarCorreoRecuperacion(): "+ex.getMessage());
           return false;
       }
       
        nombreDeUsuario = null;
        contrasena = null;
       
       return true;
    }
    
    public void enviarInformacion() {
 
        if(esCorreoElectronico(jTextFieldCorreoElectronico.getText())){
           
           if(enviarCorreoRecuperacion()){
                JOptionPane.showMessageDialog(null,"Hemos enviado la información de tu cuenta a tal correo electrónico que nos pasaste.\nSi no te ha llegado la información "
                + "dentro de una hora te recomendamos que revises bien la dirección de correo electrónico que ingresaste o revisa en la carpeta de SPAM.\nRecuerda que nosotros te enviamos la información siempre y cuando exista una cuenta vinculada con el correo electrónico ingresado.","Información",JOptionPane.INFORMATION_MESSAGE);
           }
           else{
               JOptionPane.showMessageDialog(null,"Mmmm...\nParece que el correo electrónico no existe o estamos experimentando problemas en el envío.\nIntenta de nuevo.","Error",JOptionPane.ERROR_MESSAGE);
           }
           
        }
        else{
            JOptionPane.showMessageDialog(null,"Mmmm...\nParece que el formato de texto que ingresaste no es el adecuado.\nIntenta de nuevo.","Error",JOptionPane.INFORMATION_MESSAGE);
        }
        
        jTextFieldCorreoElectronico.setText("");
        
    }
    
    
    public void dispose(){
        try {
            properties.clear();
            pattern = null;
            properties = null;
            session = null;
            inputStream.close();
            bufferedReader.close();
            inputStream = null;
            bufferedReader = null;
            msjHTML = null;
            mimeBodyPartHTML = null;
            mimeMessage = null;
            internetAddress = null;
            multipart = null;
        } catch (IOException ex) {
            Logger.getLogger(RecuperarCredencialesPanel.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButtonRecuperarCredenciales;
    private javax.swing.JLabel jLabelCorreoElectronico;
    private javax.swing.JLabel jLabelFrase;
    private javax.swing.JLabel jLabelLogo;
    private javax.swing.JLabel jLabelRegresar;
    private javax.swing.JLabel jLabelTitulo;
    private javax.swing.JTextField jTextFieldCorreoElectronico;
    // End of variables declaration//GEN-END:variables
}
